---
title: 内核参数优化
author:
category: Linux
tag: Linux
date: 2024-03-19
---

## 修改内核参数

### `sysctl` 命令

sysctl 是一个用于在 Linux 系统中运行时修改内核参数的工具。这些参数控制着系统的各种行为，例如网络配置、文件系统缓存、进程调度等。通过
sysctl，你可以动态地调整这些参数，而无需重新启动系统。

你可以使用 sysctl 来查看当前的内核参数值、修改参数值，以及加载自定义的参数配置文件。这对于优化系统性能、调试和适应不同的工作负载非常有用。

优点：

* 可以查看指定参数以及所有参数的值
* 无需重启系统，立即生效。
* 可以临时修改参数，方便测试。

缺点：

* 修改的参数仅在当前系统会话中有效，重启后失效。

### `/etc/sysctl.conf` 文件

在/etc/sysctl.conf文件中，可以设置内核参数的默认值。

缺点：

* 需要重启系统才能生效。
* 修改错误可能导致系统无法启动。

## 常见内核参数优化

> 参考阿里巴巴Java开发手册 工程结构->服务器

### TCP 超时时间

**高并发服务器建议调小 TCP 协议的 time_wait 超时时间**

**说明：** 操作系统默认 240 秒后（不同Linux发行版默认值不同），才会关闭处于 time_wait 状态的连接，在高并发访问下，服务器端会因为
处于 time_wait 的连接数太多，可能无法建立新的连接，所以需要在服务器上调小此等待值。

修改 TCP 超时时间：

```shell
# 数值仅供参考
net.ipv4.tcp_fin_timeout = 30
```

### 最大文件句柄数

**调大服务器所支持的最大文件句柄数（File Descriptor，简写为 fd）**

**说明：** 主流操作系统的设计是将 TCP/UDP 连接采用与文件一样的方式去管理，即一个连接对应于一个 fd。
主流的linux服务器默认所支持最大fd数量为1024，当并发连接数很大时很容易因为fd不足而出现`open too many files`
错误，导致新的连接无法建立。建议将 linux 服务器所支持的最大句柄数调高数倍（与服务器的内存数量相关）。

进程级配置：
修改`/etc/security/limits.conf`

```shell
# 限制单个进程最大文件句柄数（到达此限制时系统报警）
* soft nofile 65536
# 限制单个进程最大文件句柄数（到达此限制时系统报错）
* hard nofile 65536
```

系统级配置：
修改`/etc/sysctl.conf`或sysctl修改
```shell
# 限制整个系统最大文件句柄数
fs.file-max = 655350
```



