---
title: Redis与数据库一致性策略
author:
category: Redis
tag: Redis
---

有4种常见的策略，但是一般Cache Aside的方式是大多数场景下的常用方案，Cache Aside有又三种方式(变体)来处理缓存/数据库

## Cache Aside

Cache Aside的三种变体都面临两个问题，删除缓存还是更新缓存？先删缓存还是后删缓存？

### 删除还是更新缓存？

首先，删除缓存是比较好的做法。

因为更新缓存的动作，相比于直接删除缓存，操作过程比较的复杂，而且也容易出错。通常缓存业务的一些数据时，都是以JSON的格式放到Redis中，那如果更新缓存的话还需要将该JSON反序列化，然后更新其中的信息，然后再序列化放回Redis，相比于删除操作复杂了很多

### 先更新数据库后删缓存

这种处理方式，一般来说是没问题的，但是在极端情况下还是会出现一致性问题

场景一：更新数据库成功，但是去删除缓存时，由于网络或者其他原因，删除缓存的操作失败，那么缓存中的数据就一直是以前的旧数据了
场景二：请求1从DB读数据A ---> 请求2更新DB中的数据A（此时缓存中无数据 A ，故不用执行删除缓存操作 ） ---> 请求1将数据A
写入cache

适用场景：业务量不大，并发不高的情况下，可以选择该方式

### 先删缓存后更新数据库

该方式会无形中放大"读写并发"导致的数据不一致的问题。

例如该场景：请求1先把Cache中的A数据删除 ---> 请求2从DB中读取数据 --->  请求1再把DB中的A数据更新

**这种问题的后果也比较严重，那就是缓存中的值一直是错的，就会导致后续的所有命中缓存的查询结果都是错的！**

### 延迟双删

TODO

## Read/Write Through

在下面两种模式中，应用程序将缓存作为主要的数据源，不需要感知数据库，更新数据库和从数据库的读取的任务都交给缓存来代理。

这两种模式下，不需要应用自己去操作数据库，缓存自己就把活干完了。

### Read Through

缓存配置一个读模块，它知道如何将数据库中的数据写入缓存

- Cache存在，读到即返回
- Cache不存在，通过读模块从DB读取后写入Cache再返回

### Write Through

缓存配置一个写模块，它知道如何将数据写入数据库。

- Cache存在，先更新Cache，再通过写模块更新DB
- Cache不存在，通过写模块直接更新DB

## Write Behind

只更新缓存，不直接更新 DB，而是定时通过异步批量的方式更新DB

这种模式的优缺点比较明显，那就是读写速度都很快，但是可能会造成一定的数据丢失。

这种比较适合用在比如统计文章的访问量、点赞等场景中，允许数据少量丢失，但是速度要快。

## 总结

要根据自身业务选择合适的策略
