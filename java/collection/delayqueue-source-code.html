<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.6" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.22" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://hollowlatte.github.io/Note-Book/Note-Book/java/collection/delayqueue-source-code.html"><meta property="og:site_name" content="Note-Book"><meta property="og:description" content="DelayQueueç®€ä»‹ DelayQueueæ˜¯JUCåŒ…(java.util.concurrent)ä¸ºæˆ‘ä»¬æä¾›çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºPriorityQueueå®ç°çš„ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿé˜Ÿåˆ—ã€‚ å…³äºPriorityQueueå¯ä»¥å‚è€ƒç¬”è€…ç¼–å†™çš„è¿™ç¯‡æ–‡ç« : PriorityQueueæºç åˆ†æ å½“æˆ‘ä»¬å¸Œæœ›æŸä¸ªä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´æ‰èƒ½å–å‡ºå¹¶æ“ä½œæ—¶ï¼Œæˆ‘ä»¬..."><meta property="og:type" content="article"><meta property="og:image" content="https://qiniuyun.sharkchili.com/img202306301213027.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-21T08:07:11.000Z"><meta name="twitter:card" content="summary_large_image"><meta property="article:author" content="Hollow-Latte"><meta property="article:modified_time" content="2024-03-21T08:07:11.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"","image":["https://qiniuyun.sharkchili.com/img202306301213027.png","https://qiniuyun.sharkchili.com/img202306301213864.png","https://qiniuyun.sharkchili.com/img202306301213758.png","https://qiniuyun.sharkchili.com/img202306301213690.png","https://qiniuyun.sharkchili.com/img202306301213656.png","https://qiniuyun.sharkchili.com/img202306301213007.png"],"dateModified":"2024-03-21T08:07:11.000Z","author":[{"@type":"Person","name":"Hollow-Latte","url":"https://hollowlatte.github.io/Note-Book"}]}</script><meta name="robots" content="all"><meta name="author" content="Guide"><meta name="referrer" content="no-referrer"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><meta name="keywords" content="JavaåŸºç¡€, å¤šçº¿ç¨‹, JVM, è™šæ‹Ÿæœº, æ•°æ®åº“, MySQL, Spring, Redis, MyBatis, ç³»ç»Ÿè®¾è®¡, åˆ†å¸ƒå¼, RPC, é«˜å¯ç”¨, é«˜å¹¶å‘"><meta name="apple-mobile-web-app-capable" content="yes"><script>var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?5dd2e8c97962d57b7b8fea1737c01743";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();</script><link ref="preconnect" href="https://fonts.googleapis.com"><link ref="preconnect" href="https://fonts.gstatic.com" crossorigin=""><link ref="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap"><link rel="alternate" type="application/atom+xml" href="https://hollowlatte.github.io/Note-Book/Note-Book/atom.xml" title="Note-Book Atom Feed"><link rel="alternate" type="application/json" href="https://hollowlatte.github.io/Note-Book/Note-Book/feed.json" title="Note-Book JSON Feed"><link rel="alternate" type="application/rss+xml" href="https://hollowlatte.github.io/Note-Book/Note-Book/rss.xml" title="Note-Book RSS Feed"><link rel="icon" href="/Note-Book/favicon.ico"><title>Note-Book</title><meta name="description" content="DelayQueueç®€ä»‹ DelayQueueæ˜¯JUCåŒ…(java.util.concurrent)ä¸ºæˆ‘ä»¬æä¾›çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºPriorityQueueå®ç°çš„ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿé˜Ÿåˆ—ã€‚ å…³äºPriorityQueueå¯ä»¥å‚è€ƒç¬”è€…ç¼–å†™çš„è¿™ç¯‡æ–‡ç« : PriorityQueueæºç åˆ†æ å½“æˆ‘ä»¬å¸Œæœ›æŸä¸ªä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´æ‰èƒ½å–å‡ºå¹¶æ“ä½œæ—¶ï¼Œæˆ‘ä»¬...">
    <link rel="preload" href="/Note-Book/assets/style-bCPtHIxr.css" as="style"><link rel="stylesheet" href="/Note-Book/assets/style-bCPtHIxr.css">
    <link rel="modulepreload" href="/Note-Book/assets/app-CjdU_M7_.js"><link rel="modulepreload" href="/Note-Book/assets/delayqueue-source-code.html-RQP3hDFB.js"><link rel="modulepreload" href="/Note-Book/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/Note-Book/"><img class="vp-nav-logo" src="/Note-Book/logo.png" alt><!----><span class="vp-site-name hide-in-pad">Note-Book</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/home.html" aria-label="é¢è¯•æŒ‡å—"><FontIcon icon="java"></FontIcon>é¢è¯•æŒ‡å—<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="ğŸ§ç ”ç©¶"><span class="title"><FontIcon></FontIcon>ğŸ§ç ”ç©¶</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/research/open-source-project/" aria-label="å¼€æºé¡¹ç›®"><FontIcon icon="github"></FontIcon>å¼€æºé¡¹ç›®<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/research/interesting/" aria-label="å¥½ç©çš„"><FontIcon icon="github"></FontIcon>å¥½ç©çš„<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/business/" aria-label="ğŸ˜‹ä¸šåŠ¡"><FontIcon></FontIcon>ğŸ˜‹ä¸šåŠ¡<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/practice-manual/" aria-label="ğŸ˜å®è·µæ‰‹å†Œ"><FontIcon icon="about"></FontIcon>ğŸ˜å®è·µæ‰‹å†Œ<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="ğŸ˜°é—®é¢˜é›†åˆ"><span class="title"><FontIcon></FontIcon>ğŸ˜°é—®é¢˜é›†åˆ</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/problem/backend-problem/" aria-label="åç«¯é—®é¢˜"><FontIcon icon="github"></FontIcon>åç«¯é—®é¢˜<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/problem/frontend-problem/" aria-label="å‰ç«¯é—®é¢˜"><FontIcon icon="github"></FontIcon>å‰ç«¯é—®é¢˜<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/problem/non-dev/" aria-label="éå¼€å‘é—®é¢˜"><FontIcon icon="github"></FontIcon>éå¼€å‘é—®é¢˜<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/interview-shorthand/" aria-label="ğŸ’¯é¢è¯•é€Ÿè®°"><FontIcon icon="about"></FontIcon>ğŸ’¯é¢è¯•é€Ÿè®°<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/notebook/" aria-label="ğŸ«µç¬”è®°æœ¬"><FontIcon icon="book"></FontIcon>ğŸ«µç¬”è®°æœ¬<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/Note-Book/algorithm/" aria-label="ğŸ§®ç®—æ³•"><FontIcon icon="book"></FontIcon>ğŸ§®ç®—æ³•<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="ğŸ¤£ç½‘ç«™ç›¸å…³"><span class="title"><FontIcon icon="about"></FontIcon>ğŸ¤£ç½‘ç«™ç›¸å…³</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/about-the-author/" aria-label="å…³äºä½œè€…"><FontIcon icon="zuozhe"></FontIcon>å…³äºä½œè€…<!----></a></li><li class="dropdown-item"><a class="route-link nav-link" href="/Note-Book/timeline/" aria-label="æ›´æ–°å†å²"><FontIcon icon="history"></FontIcon>æ›´æ–°å†å²<!----></a></li></ul></button></div></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><div class="nav-item vp-repo"><a class="vp-repo-link" href="https://github.com/HollowLatte/Note-Book" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><GitHubIcon style="width:1.25rem;height:1.25rem;vertical-align:middle;"></GitHubIcon></a></div><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:block;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:none;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="star"></FontIcon><span class="vp-sidebar-title">å¿…çœ‹</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="interview"></FontIcon><span class="vp-sidebar-title">é¢è¯•å‡†å¤‡</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="java"></FontIcon><span class="vp-sidebar-title">Java</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="computer"></FontIcon><span class="vp-sidebar-title">è®¡ç®—æœºåŸºç¡€</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="database"></FontIcon><span class="vp-sidebar-title">æ•°æ®åº“</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="tool"></FontIcon><span class="vp-sidebar-title">å¼€å‘å·¥å…·</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="component"></FontIcon><span class="vp-sidebar-title">å¸¸ç”¨æ¡†æ¶</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="design"></FontIcon><span class="vp-sidebar-title">ç³»ç»Ÿè®¾è®¡</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="distributed-network"></FontIcon><span class="vp-sidebar-title">åˆ†å¸ƒå¼</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="et-performance"></FontIcon><span class="vp-sidebar-title">é«˜æ€§èƒ½</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable" type="button"><FontIcon icon="highavailable"></FontIcon><span class="vp-sidebar-title">é«˜å¯ç”¨</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><FontIcon></FontIcon></h1><div class="page-info"><AuthorInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></AuthorInfo><CategoryInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></CategoryInfo><TagInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></TagInfo><DateInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></DateInfo><OriginalInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></OriginalInfo><WordInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></WordInfo><ReadingTimeInfo localizeddate="2024å¹´3æœˆ21æ—¥" isoriginal="false" pageview="true" pure="true"></ReadingTimeInfo></div><hr></div><!----><!--[--><!----><!--]--><div class="theme-hope-content"><h2 id="delayqueueç®€ä»‹" tabindex="-1"><a class="header-anchor" href="#delayqueueç®€ä»‹"><span>DelayQueueç®€ä»‹</span></a></h2><p>DelayQueueæ˜¯JUCåŒ…(java.util.concurrent)ä¸ºæˆ‘ä»¬æä¾›çš„å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŸºäºPriorityQueueå®ç°çš„ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ï¼Œæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„å»¶è¿Ÿé˜Ÿåˆ—ã€‚</p><p>å…³äºPriorityQueueå¯ä»¥å‚è€ƒç¬”è€…ç¼–å†™çš„è¿™ç¯‡æ–‡ç« :</p><p><a href="http://t.csdn.cn/XJuAf" target="_blank" rel="noopener noreferrer">PriorityQueueæºç åˆ†æ<!----></a></p><p>å½“æˆ‘ä»¬å¸Œæœ›æŸä¸ªä»»åŠ¡åœ¨æŸä¸ªæ—¶é—´æ‰èƒ½å–å‡ºå¹¶æ“ä½œæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®©è¿™ä¸ªç»§æ‰¿Delayedæ¥å£ï¼Œå®ç°å…¶è®¡ç®—ä»»åŠ¡åˆ°æœŸæ—¶é—´çš„æ–¹æ³• getDelay ã€‚ç„¶åå°†ä»»åŠ¡å­˜æ”¾åˆ° DelayQueue ä¸­,é»˜è®¤æƒ…å†µä¸‹, DelayQueue ä¼šæŒ‰ç…§åˆ°æœŸæ—¶é—´å‡åºç¼–æ’ä»»åŠ¡ã€‚éšåå½“ DelayQueue å‘ç°ä»»åŠ¡åˆ°æœŸæ—¶ï¼Œæˆ‘ä»¬æ‰èƒ½ä» DelayQueue ä¸­å–å‡ºè¿™ä¸ªä»»åŠ¡å¹¶æ‰§è¡Œã€‚</p><p>è¿™ä½¿å¾— DelayQueueéå¸¸é€‚åˆè¿ç”¨äºä»¥ä¸‹ä¸¤ç§åœºæ™¯:</p><ol><li>å®šæ—¶ä»»åŠ¡ : DelayQueue éå¸¸é€‚åˆç”¨äºå¤„ç†é‚£äº›åˆ°æœŸæ‰èƒ½æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä¾‹å¦‚ç”¨æˆ·è§¦å‘ä¸‹å•è¯·æ±‚ï¼Œæˆ‘ä»¬è§„å®š15minåæœªæ”¯ä»˜åˆ™å–æ¶ˆè®¢å•ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æäº¤ä¸€ä¸ª15minååˆ°æŸ¥è¯¢ç”¨æˆ·ä¸‹å•æƒ…å†µçš„ä»»åŠ¡ç»™DelayQueueï¼Œå¦‚æœ15minåå–å‡ºè¯¥ä»»åŠ¡å‘ç°ç”¨æˆ·è¿˜æœªä¸‹å•ï¼Œåˆ™å–æ¶ˆè¿™ä¸ªè®¢å•ã€‚</li><li>ç¼“å­˜è¿‡æœŸ : å‡å¦‚æˆ‘ä»¬ä½¿ç”¨Javaç»´æŠ¤ä¸€ä¸ªå†…å­˜ï¼Œæˆ‘ä»¬å¸Œæœ›ç¼“å­˜å…·å¤‡æ—¶æ•ˆæ€§ï¼ŒåŒæ ·æˆ‘ä»¬å¯ä»¥å°è£…ä¸€ä¸ªç¼“å­˜è¿‡æœŸåˆ é™¤çš„ä»»åŠ¡æäº¤åˆ°DelayQueueï¼ŒDelayQueueä¼šåœ¨åˆ°æœŸåå–å‡ºè¿™ä¸ªä»»åŠ¡å¹¶å°†ç¼“å­˜æ•°æ®åˆ é™¤ã€‚</li></ol><h2 id="delayqueueå‘å±•å²" tabindex="-1"><a class="header-anchor" href="#delayqueueå‘å±•å²"><span>DelayQueueå‘å±•å²</span></a></h2><p>DelayQueue æœ€æ—©æ˜¯åœ¨ Java 5 ä¸­å¼•å…¥çš„ï¼Œä½œä¸º java.util.concurrent åŒ…ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæ”¯æŒåŸºäºæ—¶é—´çš„ä»»åŠ¡è°ƒåº¦å’Œç¼“å­˜è¿‡æœŸåˆ é™¤ç­‰åœºæ™¯ï¼Œè¯¥ç‰ˆæœ¬ä»…ä»…æ”¯æŒå»¶è¿ŸåŠŸèƒ½çš„å®ç°ï¼Œè¿˜æœªè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚</p><p>åœ¨ Java 6 ä¸­ï¼ŒDelayQueue çš„å®ç°è¿›è¡Œäº†ä¼˜åŒ–ï¼Œé€šè¿‡ä½¿ç”¨ ReentrantLock å’Œ Condition è§£å†³çº¿ç¨‹å®‰å…¨åŠçº¿ç¨‹é—´äº¤äº’çš„æ•ˆç‡ï¼Œæé«˜äº†å…¶æ€§èƒ½å’Œå¯é æ€§ã€‚</p><p>åœ¨ Java 7 ä¸­ï¼ŒDelayQueue çš„å®ç°è¿›è¡Œäº†è¿›ä¸€æ­¥çš„ä¼˜åŒ–ï¼Œé€šè¿‡ä½¿ç”¨ CAS æ“ä½œå®ç°å…ƒç´ çš„æ·»åŠ å’Œç§»é™¤æ“ä½œï¼Œæé«˜äº†å…¶å¹¶å‘æ“ä½œæ€§èƒ½ã€‚</p><p>åœ¨ Java 8 ä¸­ï¼ŒDelayQueue çš„å®ç°æ²¡æœ‰è¿›è¡Œé‡å¤§å˜åŒ–ï¼Œä½†æ˜¯åœ¨ java.time åŒ…ä¸­å¼•å…¥äº†æ–°çš„æ—¶é—´ç±»ï¼Œå¦‚ Duration å’Œ Instantï¼Œä½¿å¾—ä½¿ç”¨ DelayQueue è¿›è¡ŒåŸºäºæ—¶é—´çš„è°ƒåº¦æ›´åŠ æ–¹ä¾¿å’Œçµæ´»ã€‚</p><p>åœ¨ Java 9 ä¸­ï¼ŒDelayQueue çš„å®ç°è¿›è¡Œäº†ä¸€äº›å¾®å°çš„æ”¹è¿›ï¼Œä¸»è¦æ˜¯å¯¹ä»£ç è¿›è¡Œäº†ä¸€äº›ä¼˜åŒ–å’Œç²¾ç®€ã€‚</p><p>æ€»çš„æ¥è¯´ï¼ŒDelayQueue çš„å‘å±•å²ä¸»è¦æ˜¯é€šè¿‡ä¼˜åŒ–å…¶å®ç°æ–¹å¼å’Œæé«˜å…¶æ€§èƒ½å’Œå¯é æ€§ï¼Œä½¿å…¶æ›´åŠ é€‚ç”¨äºåŸºäºæ—¶é—´çš„è°ƒåº¦å’Œç¼“å­˜è¿‡æœŸåˆ é™¤ç­‰åœºæ™¯ã€‚</p><h2 id="delayqueueå¸¸è§ä½¿ç”¨åœºæ™¯ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#delayqueueå¸¸è§ä½¿ç”¨åœºæ™¯ç¤ºä¾‹"><span>DelayQueueå¸¸è§ä½¿ç”¨åœºæ™¯ç¤ºä¾‹</span></a></h2><h4 id="å®šæ—¶ä»»åŠ¡" tabindex="-1"><a class="header-anchor" href="#å®šæ—¶ä»»åŠ¡"><span>å®šæ—¶ä»»åŠ¡</span></a></h4><p>æˆ‘ä»¬å¸Œæœ›ä»»åŠ¡å¯ä»¥æŒ‰ç…§æˆ‘ä»¬é¢„æœŸçš„æ—¶é—´æ‰§è¡Œï¼Œä¾‹å¦‚æäº¤3ä¸ªä»»åŠ¡ï¼Œåˆ†åˆ«è¦æ±‚1sã€2sã€3såæ‰§è¡Œï¼Œå³ä½¿æ˜¯ä¹±åºæ·»åŠ ï¼Œ1såè¦æ±‚1sæ‰§è¡Œçš„ä»»åŠ¡ä¼šå‡†æ—¶æ‰§è¡Œã€‚</p><figure><img src="https://qiniuyun.sharkchili.com/img202306301213027.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><p>å¯¹æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨DelayQueueæ¥å®ç°,æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆéœ€è¦ç»§æ‰¿Delayedå®ç° DelayedTaskï¼Œå®ç°getDelayæ–¹æ³•ä»¥åŠä¼˜å…ˆçº§æ¯”è¾ƒcompareToã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>/**
 * å»¶è¿Ÿä»»åŠ¡
 */
public class DelayedTask implements Delayed <span class="token punctuation">{</span>
    /**
     * ä»»åŠ¡åˆ°æœŸæ—¶é—´
     */
    private long executeTime<span class="token punctuation">;</span>
    /**
     * ä»»åŠ¡
     */
    private Runnable task<span class="token punctuation">;</span>

    public DelayedTask<span class="token punctuation">(</span>long delay, Runnable task<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this.executeTime <span class="token operator">=</span> System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> + delay<span class="token punctuation">;</span>
        this.task <span class="token operator">=</span> task<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * æŸ¥çœ‹å½“å‰ä»»åŠ¡è¿˜æœ‰å¤šä¹…åˆ°æœŸ
     * @param unit
     * @return
     */
    @Override
    public long getDelay<span class="token punctuation">(</span>TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> unit.convert<span class="token punctuation">(</span>executeTime - System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>, TimeUnit.MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * å»¶è¿Ÿé˜Ÿåˆ—éœ€è¦åˆ°æœŸæ—¶é—´å‡åºå…¥é˜Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å®ç°compareToè¿›è¡Œåˆ°æœŸæ—¶é—´æ¯”è¾ƒ
     * @param o
     * @return
     */
    @Override
    public int compareTo<span class="token punctuation">(</span>Delayed o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> Long.compare<span class="token punctuation">(</span>this.executeTime, <span class="token punctuation">((</span>DelayedTask<span class="token punctuation">)</span> o<span class="token punctuation">)</span>.executeTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public void <span class="token function-name function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        task.run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆä»»åŠ¡çš„å°è£…ä¹‹åï¼Œä½¿ç”¨å°±å¾ˆç®€å•äº†ï¼Œè®¾ç½®å¥½å¤šä¹…åˆ°æœŸç„¶åå°†ä»»åŠ¡æäº¤åˆ°å»¶è¿Ÿé˜Ÿåˆ—ä¸­å³å¯ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws InterruptedException <span class="token punctuation">{</span>
        // åˆ›å»ºå»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¹¶æ·»åŠ ä»»åŠ¡
        DelayQueue<span class="token operator">&lt;</span>DelayedTask<span class="token operator">&gt;</span> delayQueue <span class="token operator">=</span> new DelayQueue<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        //åˆ†åˆ«æ·»åŠ 1sã€2sã€3såˆ°æœŸçš„ä»»åŠ¡
        delayQueue.add<span class="token punctuation">(</span>new DelayedTask<span class="token punctuation">(</span><span class="token number">2000</span>, <span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> System.out.println<span class="token punctuation">(</span><span class="token string">&quot;Task 2&quot;</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delayQueue.add<span class="token punctuation">(</span>new DelayedTask<span class="token punctuation">(</span><span class="token number">1000</span>, <span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> System.out.println<span class="token punctuation">(</span><span class="token string">&quot;Task 1&quot;</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        delayQueue.add<span class="token punctuation">(</span>new DelayedTask<span class="token punctuation">(</span><span class="token number">3000</span>, <span class="token punctuation">(</span><span class="token punctuation">)</span> -<span class="token operator">&gt;</span> System.out.println<span class="token punctuation">(</span><span class="token string">&quot;Task 3&quot;</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        // å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œ
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>delayQueue.isEmpty<span class="token punctuation">(</span><span class="token punctuation">))</span> <span class="token punctuation">{</span>
            //é˜»å¡è·å–æœ€å…ˆåˆ°æœŸçš„ä»»åŠ¡
            DelayedTask task <span class="token operator">=</span> delayQueue.take<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                task.execute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»è¾“å‡ºç»“æœå¯ä»¥çœ‹å‡ºï¼Œå³ä½¿ç¬”è€…å…ˆæåˆ°2såˆ°æœŸçš„ä»»åŠ¡ï¼Œ1såˆ°æœŸçš„ä»»åŠ¡Task1è¿˜æ˜¯ä¼˜å…ˆæ‰§è¡Œçš„ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>Task <span class="token number">1</span>
Task <span class="token number">2</span>
Task <span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ç¼“å­˜è¿‡æœŸ" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜è¿‡æœŸ"><span>ç¼“å­˜è¿‡æœŸ</span></a></h4><p>å¯¹äºæŸäº›çƒ­ç‚¹æ•°æ®ï¼Œæˆ‘ä»¬å¸Œæœ›å°†å…¶ç¼“å­˜åˆ°å†…å­˜ä¸­ï¼Œä¸ºé¿å…æ²¡å¿…è¦çš„å†…å­˜å ç”¨ï¼Œæˆ‘ä»¬å¸Œæœ›å¯¹ç¼“å­˜æ•°æ®è®¾ç½®åˆ°æœŸå¤±æ•ˆã€‚</p><figure><img src="https://qiniuyun.sharkchili.com/img202306301213864.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><p>å¯¹äºè¿™ç§éœ€æ±‚ï¼Œå¦‚æœä¸å¸Œæœ›å¼•å…¥ä¸­é—´ä»¶æˆ–è€…ç¬¬ä¸‰æ–¹å·¥å…·çš„è¯ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡DelayQueueå®ç°ï¼Œè¿™é‡Œç¬”è€…å¤§æ¦‚ä»‹ç»ä¸€ä¸‹å®ç°æ€è·¯:</p><ol><li>å°è£…è¦æäº¤åˆ°DelayQueueçš„ä»»åŠ¡ï¼Œè¯¥ä»»åŠ¡æŒ‡æ˜åˆ°æœŸè¦åˆ é™¤çš„keyå’Œåˆ é™¤æ—¶é—´ã€‚</li><li>å°è£…ç¼“å­˜ç±»ï¼Œå®ç°ç¼“å­˜æ•°æ®çš„å­˜å–ä»¥åŠç¼“å­˜åˆ°æœŸæ¸…é™¤çš„é€»è¾‘ã€‚</li><li>æµ‹è¯•ç±»ï¼Œæµ‹è¯•æœªåˆ°æœŸæ—¶ç¼“å­˜æ˜¯å¦å¯ä»¥è·å–ä»¥åŠåˆ°æœŸåæ˜¯å¦è¿”å›nullã€‚</li></ol><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªç¼“å­˜çš„ä»»åŠ¡CacheItemï¼Œå‘ŠçŸ¥å»¶è¿Ÿé˜Ÿåˆ—ä½•æ—¶åˆ°æœŸä»¥åŠä¼˜å…ˆçº§å¦‚ä½•åˆ¤æ–­ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>/**
 * å®šæ—¶åˆ é™¤ç¼“å­˜é¡¹
 * @param <span class="token operator">&lt;</span>K<span class="token operator">&gt;</span>
 */
public class CacheItem<span class="token operator">&lt;</span>K<span class="token operator">&gt;</span> implements Delayed <span class="token punctuation">{</span>
    /**
     * åˆ°æœŸå°†è¢«åˆ é™¤çš„keyåç§°
     */
    private final K key<span class="token punctuation">;</span>
    /**
     * åˆ°æœŸæ—¶é—´
     */
    private final long expireTime<span class="token punctuation">;</span>


    /**
     * è®¾ç½®keyä»¥åŠkeyçš„åˆ°æœŸæ—¶é—´
     * @param key
     * @param expireAfterWrite
     * @param timeUnit
     */
    public CacheItem<span class="token punctuation">(</span>K key, long expireAfterWrite, TimeUnit timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this.key <span class="token operator">=</span> key<span class="token punctuation">;</span>
        this.expireTime <span class="token operator">=</span> System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span> + timeUnit.toMillis<span class="token punctuation">(</span>expireAfterWrite<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * æŸ¥è¯¢åˆ°æœŸæ—¶é—´
     * @param unit
     * @return
     */
    @Override
    public long getDelay<span class="token punctuation">(</span>TimeUnit unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> unit.convert<span class="token punctuation">(</span>expireTime - System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>, TimeUnit.MILLISECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    @Override
    public int compareTo<span class="token punctuation">(</span>Delayed o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> Long.compare<span class="token punctuation">(</span>expireTime, <span class="token punctuation">((</span>CacheItem<span class="token operator">&lt;</span>?<span class="token operator">&gt;</span><span class="token punctuation">)</span> o<span class="token punctuation">)</span>.expireTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    public K <span class="token function-name function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> key<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆä»»åŠ¡ç¼–å†™ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å®ç°æˆ‘ä»¬è‡ªå·±çš„ç¼“å­˜å·¥å…·äº†ï¼Œè¿™é‡Œå®ç°çš„æ–¹å¼éå¸¸ç®€å•ï¼Œå¯¹äºç¼“å­˜æ•°æ®çš„å­˜å–æˆ‘ä»¬éƒ½ç”¨ConcurrentHashMapæ¥ç®¡ç†ï¼Œè€Œåˆ°æœŸåˆ é™¤çš„é€»è¾‘ï¼Œæˆ‘ä»¬åœ¨å­˜ç¼“å­˜æ•°æ®çš„åŒæ—¶ï¼Œæäº¤ä¸€ä¸ªç¼“å­˜åˆ°æœŸçš„ä»»åŠ¡ç»™DelayQueueå³å¯ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>/**
 * åŸºäºå»¶è¿Ÿé˜Ÿåˆ—å®ç°ç¼“å­˜è¿‡æœŸçš„ç¤ºä¾‹
 * @param <span class="token operator">&lt;</span>K<span class="token operator">&gt;</span>
 * @param <span class="token operator">&lt;</span>V<span class="token operator">&gt;</span>
 */
public class Cache<span class="token operator">&lt;</span>K, V<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    /**
     * å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå®šæ—¶æ¸…é™¤åˆ°æœŸç¼“å­˜æ•°æ®
     */
    private final DelayQueue<span class="token operator">&lt;</span>CacheItem<span class="token operator">&lt;</span>K<span class="token operator">&gt;&gt;</span> queue <span class="token operator">=</span> new DelayQueue<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    /**
     * å­˜æ”¾ç¼“å­˜çš„é”®å€¼å¯¹
     */
    private final  Map<span class="token operator">&lt;</span>K, V<span class="token operator">&gt;</span> cache <span class="token operator">=</span> new ConcurrentHashMap<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    /**
     * æ„é€ æ–¹æ³•åˆ›å»ºä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå®šæ—¶æŸ¥è¯¢åˆ°æœŸçš„keyå¹¶æ¸…é™¤ç¼“å­˜
     */
    public <span class="token function-name function">Cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Thread t <span class="token operator">=</span> new Thread<span class="token punctuation">(</span>this::expireItems<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t.setDaemon<span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t.start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    /**
     * æ·»åŠ æ•°æ®åˆ°ç¼“å­˜ä¸­
     * @param key
     * @param value
     * @param expireAfterWrite
     * @param timeUnit
     */
    public void put<span class="token punctuation">(</span>K key, V value, long expireAfterWrite, TimeUnit timeUnit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        //æ’å…¥æ•°æ®åˆ°ç¼“å­˜ä¸­
        cache.put<span class="token punctuation">(</span>key, value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        //æ·»åŠ ä¸€ä¸ªä»»åŠ¡ï¼Œåˆ°æœŸæ—¶æ¸…é™¤ç¼“å­˜ä¸­çš„key
        queue.put<span class="token punctuation">(</span>new CacheItem<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span>key, expireAfterWrite, timeUnit<span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * ä»ç¼“å­˜ä¸­è·å–æ•°æ®
     * @param key
     * @return
     */
    public V get<span class="token punctuation">(</span>K key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin class-name">return</span> cache.get<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    private void <span class="token function-name function">expireItems</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            try <span class="token punctuation">{</span>
                CacheItem<span class="token operator">&lt;</span>K<span class="token operator">&gt;</span> item <span class="token operator">=</span> queue.take<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                System.out.println<span class="token punctuation">(</span><span class="token string">&quot;item:&quot;</span> + item.getKey<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">&quot;å·²è¿‡æœŸ,å¼€å§‹åˆ é™¤&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                cache.remove<span class="token punctuation">(</span>item.getKey<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
                System.out.println<span class="token punctuation">(</span><span class="token string">&quot;item:&quot;</span> + item.getKey<span class="token punctuation">(</span><span class="token punctuation">)</span> + <span class="token string">&quot;åˆ é™¤æˆåŠŸ&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>InterruptedException e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Thread.currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span>.interrupt<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token builtin class-name">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


   
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®Œæˆç¼“å­˜å·¥å…·å¼€å‘ä¹‹åï¼Œæˆ‘ä»¬ä¸å¦¨è¿›è¡Œä¸€ä¸‹ç®€å•çš„æµ‹è¯•ï¼Œæˆ‘ä»¬å¾€ç¼“å­˜ä¸­æ·»åŠ ä¸€ä¸ª5såˆ°æœŸçš„ç¼“å­˜ï¼Œçœ‹çœ‹6så‰å’Œ6såçš„è·å–æƒ…å†µã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code> public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws InterruptedException <span class="token punctuation">{</span>
        Cache<span class="token operator">&lt;</span>String, Integer<span class="token operator">&gt;</span> cache <span class="token operator">=</span> new Cache<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        // å­˜å‚¨æ•°æ®é¡¹ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º <span class="token number">5</span> ç§’
        cache.put<span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span>, <span class="token number">1</span>, <span class="token number">5</span>, TimeUnit.<span class="token environment constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache.put<span class="token punctuation">(</span><span class="token string">&quot;key2&quot;</span>, <span class="token number">2</span>, <span class="token number">5</span>, TimeUnit.<span class="token environment constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        // è·å–æ•°æ®é¡¹
        System.out.println<span class="token punctuation">(</span>cache.get<span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span> // è¾“å‡º <span class="token number">1</span>

        // ç­‰å¾… <span class="token number">6</span> ç§’ï¼Œè®©æ•°æ®é¡¹è¿‡æœŸ
        Thread.sleep<span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        // å†æ¬¡è·å–æ•°æ®é¡¹
        System.out.println<span class="token punctuation">(</span>cache.get<span class="token punctuation">(</span><span class="token string">&quot;key1&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span> // è¾“å‡º null
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»è¾“å‡ºç»“æœæ¥çœ‹5såˆ°æœŸçš„ç¼“å­˜æ•°æ®åœ¨ä¼‘çœ 6såå·²ç»æ— æ³•è·å–åˆ°äº†:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code><span class="token number">1</span>
item:key1å·²è¿‡æœŸ,å¼€å§‹åˆ é™¤
item:key1åˆ é™¤æˆåŠŸ
item:key2å·²è¿‡æœŸ,å¼€å§‹åˆ é™¤
item:key2åˆ é™¤æˆåŠŸ
null
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="delayqueueæºç è§£æ" tabindex="-1"><a class="header-anchor" href="#delayqueueæºç è§£æ"><span>DelayQueueæºç è§£æ</span></a></h2><h3 id="æ ¸å¿ƒæˆå‘˜å˜é‡" tabindex="-1"><a class="header-anchor" href="#æ ¸å¿ƒæˆå‘˜å˜é‡"><span>æ ¸å¿ƒæˆå‘˜å˜é‡</span></a></h3><p>äº†è§£äº†DelayQueueçš„ä½¿ç”¨æ–¹å¼ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥æ·±å…¥çš„å»äº†è§£DelayQueueæºç äº†ã€‚é¦–å…ˆæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å‡ ä¸ªæ¯”è¾ƒæ ¸å¿ƒçš„æˆå‘˜å˜é‡:</p><ol><li>lock : æˆ‘ä»¬éƒ½çŸ¥é“DelayQueueå­˜å–æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯å­˜å–å…ƒç´ æ—¶çº¿ç¨‹å®‰å…¨ï¼Œæˆ‘ä»¬å°±éœ€è¦åœ¨å­˜å–æ—¶ä¸Šé”,è€ŒDelayQueueå°±æ˜¯åŸºäºlockç‹¬å é”ç¡®ä¿å­˜å–æ“ä½œçš„çº¿ç¨‹å®‰å…¨ã€‚</li><li>q : å»¶è¿Ÿé˜Ÿåˆ—è¦æ±‚å…ƒç´ æŒ‰ç…§åˆ°æœŸæ—¶é—´è¿›è¡Œå‡åºæ’åˆ—ï¼Œæ‰€ä»¥å…ƒç´ æ·»åŠ æ—¶åŠ¿å¿…éœ€è¦è¿›è¡Œä¼˜å…ˆçº§æ’åº,æ‰€ä»¥DelayQueueåº•å±‚å…ƒç´ çš„å­˜å–éƒ½æ˜¯é€šè¿‡è¿™ä¸ªä¼˜å…ˆé˜Ÿåˆ—PriorityQueueçš„æˆå‘˜å˜é‡qæ¥ç®¡ç†çš„ã€‚</li><li>leader : å»¶è¿Ÿé˜Ÿåˆ—çš„ä»»åŠ¡åªæœ‰åˆ°æœŸä¹‹åæ‰ä¼šæ‰§è¡Œ,å¯¹äºæ²¡æœ‰åˆ°æœŸçš„ä»»åŠ¡åªæœ‰ç­‰å¾…,ä¸ºäº†ç¡®ä¿ä¼˜å…ˆçº§æœ€é«˜çš„ä»»åŠ¡åˆ°æœŸåå¯ä»¥å³åˆ»è¢«æ‰§è¡Œ,è®¾è®¡è€…å°±ç”¨leaderæ¥ç®¡ç†å»¶è¿Ÿä»»åŠ¡ï¼Œåªæœ‰leaderæ‰€æŒ‡å‘çš„çº¿ç¨‹æ‰å…·å¤‡å®šæ—¶ç­‰å¾…ä»»åŠ¡åˆ°æœŸæ‰§è¡Œçš„æƒé™ï¼Œè€Œå…¶ä»–é‚£äº›ä¼˜å…ˆçº§ä½çš„ä»»åŠ¡åªèƒ½æ— é™æœŸç­‰å¾…ï¼Œç›´åˆ°leaderçº¿ç¨‹æ‰§è¡Œå®Œæ‰‹å¤´çš„å»¶è¿Ÿä»»åŠ¡åå”¤é†’å®ƒã€‚</li><li>available : ä¸Šæ–‡è®²è¿°leaderçº¿ç¨‹æ—¶æåˆ°çš„ç­‰å¾…å”¤é†’æ“ä½œçš„äº¤äº’å°±æ˜¯é€šè¿‡ available å®ç°çš„ï¼Œå‡å¦‚çº¿ç¨‹1å°è¯•åœ¨ç©ºçš„DelayQueueè·å–ä»»åŠ¡æ—¶ï¼Œavailable å°±ä¼šå°†å…¶æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ç›´åˆ°æœ‰ä¸€ä¸ªçº¿ç¨‹æ·»åŠ ä¸€ä¸ªå»¶è¿Ÿä»»åŠ¡åé€šè¿‡available çš„signalæ–¹æ³•å°†å…¶å”¤é†’ã€‚</li></ol><p>æ‰€æœ‰æˆå‘˜å˜é‡çš„å®šä¹‰å¦‚ä¸‹:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>	//å¯é‡å…¥é”ï¼Œå®ç°çº¿ç¨‹å®‰å…¨çš„å…³é”®
    private final transient ReentrantLock lock <span class="token operator">=</span> new ReentrantLock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    //å»¶è¿Ÿé˜Ÿåˆ—åº•å±‚å­˜å‚¨æ•°æ®çš„é›†åˆ,ç¡®ä¿å…ƒç´ æŒ‰ç…§åˆ°æœŸæ—¶é—´å‡åºæ’åˆ—
    private final PriorityQueue<span class="token operator">&lt;</span>E<span class="token operator">&gt;</span> q <span class="token operator">=</span> new PriorityQueue<span class="token operator">&lt;</span>E<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 	//æŒ‡å‘å‡†å¤‡æ‰§è¡Œä¼˜å…ˆçº§æœ€é«˜çš„çº¿ç¨‹
    private Thread leader <span class="token operator">=</span> null<span class="token punctuation">;</span>
	//å®ç°å¤šçº¿ç¨‹ä¹‹é—´ç­‰å¾…å”¤é†’çš„äº¤äº’
    private final Condition available <span class="token operator">=</span> lock.newCondition<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ„é€ æ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#æ„é€ æ–¹æ³•"><span>æ„é€ æ–¹æ³•</span></a></h3><p>ç›¸è¾ƒäºå…¶ä»–çš„å¹¶å‘å®¹å™¨ï¼Œå»¶è¿Ÿé˜Ÿåˆ—çš„æ„é€ æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå®ƒåªæœ‰ä¸¤ä¸ªæ„é€ æ–¹æ³•ï¼Œå› ä¸ºæ‰€æœ‰æˆå‘˜å˜é‡åœ¨ç±»åŠ è½½æ—¶éƒ½å·²ç»åˆå§‹å®Œæˆäº†ï¼Œæ‰€ä»¥é»˜è®¤æ„é€ æ–¹æ³•ä»€ä¹ˆä¹Ÿæ²¡åšã€‚è¿˜æœ‰ä¸€ä¸ªä¼ å…¥Collectionå¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼Œå®ƒä¼šå°†è°ƒç”¨addAllå°†é›†åˆå…ƒç´ å­˜åˆ°ä¼˜å…ˆé˜Ÿåˆ—qä¸­ã€‚</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>	public <span class="token function-name function">DelayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

 
    public DelayQueue<span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>? extends E<span class="token operator">&gt;</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        this.addAll<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ·»åŠ å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#æ·»åŠ å…ƒç´ "><span>æ·»åŠ å…ƒç´ </span></a></h3><p>DelayQueue æ·»åŠ å…ƒç´ çš„æ–¹æ³•æ— è®ºæ˜¯addã€putè¿˜æ˜¯offer,æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨ä¸€ä¸‹ offer ,æ‰€ä»¥äº†è§£å»¶è¿Ÿé˜Ÿåˆ—çš„æ·»åŠ é€»è¾‘æˆ‘ä»¬åªéœ€é˜…è¯»offeræ–¹æ³•å³å¯ã€‚</p><p>offer æ–¹æ³•çš„æ•´ä½“é€»è¾‘ä¸º:</p><ol><li>å°è¯•è·å– lock ã€‚</li><li>å¦‚æœä¸Šé”æˆåŠŸ,åˆ™è°ƒ q çš„ offer æ–¹æ³•å°†å…ƒç´ å­˜æ”¾åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚</li><li>è°ƒç”¨ peek æ–¹æ³•çœ‹çœ‹å½“å‰é˜Ÿé¦–å…ƒç´ æ˜¯å¦å°±æ˜¯æœ¬æ¬¡å…¥é˜Ÿçš„å…ƒç´ ,å¦‚æœæ˜¯åˆ™è¯´æ˜å½“å‰è¿™ä¸ªå…ƒç´ æ˜¯å³å°†åˆ°æœŸçš„ä»»åŠ¡(å³ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ )ï¼Œäºæ˜¯å°†leaderè®¾ç½®ä¸ºç©º,é€šçŸ¥å› ä¸ºé˜Ÿåˆ—ä¸ºç©ºæ—¶è°ƒç”¨takeç­‰æ–¹æ³•å¯¼è‡´é˜»å¡çš„çº¿ç¨‹æ¥äº‰æŠ¢å…ƒç´ ã€‚</li><li>ä¸Šè¿°æ­¥éª¤æ‰§è¡Œå®Œæˆï¼Œé‡Šæ”¾lockã€‚</li><li>è¿”å›trueã€‚</li></ol><p>æºç å¦‚ä¸‹ï¼Œç¬”è€…å·²è¯¦ç»†æ³¨é‡Šï¼Œè¯»è€…å¯è‡ªè¡Œå‚é˜…:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public boolean offer<span class="token punctuation">(</span>E e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		//å°è¯•è·å–lock 
        final ReentrantLock lock <span class="token operator">=</span> this.lock<span class="token punctuation">;</span>
        lock.lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
        //å¦‚æœä¸Šé”æˆåŠŸ,åˆ™è°ƒqçš„offeræ–¹æ³•å°†å…ƒç´ å­˜æ”¾åˆ°ä¼˜å…ˆé˜Ÿåˆ—ä¸­
            q.offer<span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            //è°ƒç”¨peekæ–¹æ³•çœ‹çœ‹å½“å‰é˜Ÿé¦–å…ƒç´ æ˜¯å¦å°±æ˜¯æœ¬æ¬¡å…¥é˜Ÿçš„å…ƒç´ ,å¦‚æœæ˜¯åˆ™è¯´æ˜å½“å‰è¿™ä¸ªå…ƒç´ æ˜¯å³å°†åˆ°æœŸçš„ä»»åŠ¡<span class="token punctuation">(</span>å³ä¼˜å…ˆçº§æœ€é«˜çš„å…ƒç´ <span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>q.peek<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            //å°†leaderè®¾ç½®ä¸ºç©º,é€šçŸ¥è°ƒç”¨å–å…ƒç´ æ–¹æ³•è€Œé˜»å¡çš„çº¿ç¨‹æ¥äº‰æŠ¢è¿™ä¸ªä»»åŠ¡
                leader <span class="token operator">=</span> null<span class="token punctuation">;</span>
                available.signal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token builtin class-name">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
        //ä¸Šè¿°æ­¥éª¤æ‰§è¡Œå®Œæˆï¼Œé‡Šæ”¾lock
            lock.unlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è·å–å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#è·å–å…ƒç´ "><span>è·å–å…ƒç´ </span></a></h3><p>DelayQueue ä¸­è·å–å…ƒç´ çš„æ–¹å¼åˆ†ä¸ºé˜»å¡å¼å’Œéé˜»å¡å¼ï¼Œå…ˆæ¥çœ‹çœ‹é€»è¾‘æ¯”è¾ƒå¤æ‚çš„é˜»å¡å¼è·å–å…ƒç´ æ–¹æ³•take,ä¸ºäº†è®©è¯»è€…å¯ä»¥æ›´ç›´è§‚çš„äº†è§£é˜»å¡å¼è·å–å…ƒç´ çš„å…¨æµç¨‹ï¼Œç¬”è€…å°†ä»¥3ä¸ªçº¿ç¨‹å¹¶å‘è·å–å…ƒç´ ä¸ºä¾‹è®²è¿°takeçš„å·¥ä½œæµç¨‹ã€‚</p><ol><li>é¦–å…ˆ3ä¸ªçº¿ç¨‹ä¼šå°è¯•è·å–å¯é‡å…¥é”lock,å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰3ä¸ªçº¿ç¨‹åˆ†åˆ«æ˜¯t1ã€t2ã€t3,éšåt1å¾—åˆ°äº†é”ï¼Œè€Œt2ã€t3æ²¡æœ‰æŠ¢åˆ°é”ï¼Œæ•…å°†è¿™ä¸¤ä¸ªçº¿ç¨‹å­˜å…¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚</li></ol><figure><img src="https://qiniuyun.sharkchili.com/img202306301213758.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><ol start="2"><li>ç´§æ¥ç€t1å¼€å§‹è¿›è¡Œå…ƒç´ è·å–çš„é€»è¾‘ã€‚</li><li>çº¿ç¨‹t1é¦–å…ˆä¼šæŸ¥çœ‹DelayQueueé˜Ÿåˆ—é¦–å…ƒç´ æ˜¯å¦ä¸ºç©ºã€‚</li><li>å¦‚æœå…ƒç´ ä¸ºç©ºï¼Œåˆ™è¯´æ˜å½“å‰é˜Ÿåˆ—æ²¡æœ‰ä»»ä½•å…ƒç´ ï¼Œæ•…t1å°±ä¼šè¢«é˜»å¡å­˜åˆ°conditionWaiterè¿™ä¸ªé˜Ÿåˆ—ä¸­ã€‚</li></ol><figure><img src="https://qiniuyun.sharkchili.com/img202306301213690.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><p>æ³¨æ„ï¼Œè°ƒç”¨awaitä¹‹åt1å°±ä¼šé‡Šæ”¾lcoké”ï¼Œå‡å¦‚DelayQueueæŒç»­ä¸ºç©ºï¼Œé‚£ä¹ˆt2ã€t3ä¹Ÿä¼šåƒt1ä¸€æ ·æ‰§è¡Œç›¸åŒçš„é€»è¾‘å¹¶è¿›å…¥conditionWaiteré˜Ÿåˆ—ä¸­ã€‚</p><figure><img src="https://qiniuyun.sharkchili.com/img202306301213656.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><p>å¦‚æœå…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™åˆ¤æ–­å½“å‰ä»»åŠ¡æ˜¯å¦åˆ°æœŸï¼Œå¦‚æœå…ƒç´ åˆ°æœŸï¼Œåˆ™ç›´æ¥è¿”å›å‡ºå»ã€‚å¦‚æœå…ƒç´ æœªåˆ°æœŸï¼Œåˆ™åˆ¤æ–­å½“å‰leaderçº¿ç¨‹(DelayQueueä¸­å”¯ä¸€ä¸€ä¸ªå¯ä»¥ç­‰å¾…å¹¶è·å–å…ƒç´ çš„çº¿ç¨‹å¼•ç”¨)æ˜¯å¦ä¸ºç©ºï¼Œè‹¥ä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜å½“å‰leaderæ­£åœ¨ç­‰å¾…æ‰§è¡Œä¸€ä¸ªä¼˜å…ˆçº§æ¯”å½“å‰å…ƒç´ è¿˜é«˜çš„å…ƒç´ åˆ°æœŸï¼Œæ•…å½“å‰çº¿ç¨‹t1åªèƒ½è°ƒç”¨awaitè¿›å…¥æ— é™æœŸç­‰å¾…ï¼Œç­‰åˆ°leaderå–å¾—å…ƒç´ åå”¤é†’ã€‚</p><figure><img src="https://qiniuyun.sharkchili.com/img202306301213007.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" tabindex="0"><figcaption>åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°</figcaption></figure><p>åä¹‹è‹¥leaderçº¿ç¨‹ä¸ºç©ºï¼Œåˆ™å°†å½“å‰çº¿ç¨‹è®¾ç½®ä¸ºleaderå¹¶è¿›å…¥æœ‰é™æœŸç­‰å¾…,åˆ°æœŸåå–å‡ºå…ƒç´ å¹¶è¿”å›ã€‚</p><p>è‡ªæ­¤æˆ‘ä»¬é˜»å¡å¼è·å–å…ƒç´ çš„é€»è¾‘éƒ½å·²å®Œæˆå,æºç å¦‚ä¸‹ï¼Œè¯»è€…å¯è‡ªè¡Œå‚é˜…:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public E take<span class="token punctuation">(</span><span class="token punctuation">)</span> throws InterruptedException <span class="token punctuation">{</span>
		// å°è¯•è·å–å¯é‡å…¥é”,å°†åº•å±‚AQSçš„stateè®¾ç½®ä¸º1,å¹¶è®¾ç½®ä¸ºç‹¬å é”
        final ReentrantLock lock <span class="token operator">=</span> this.lock<span class="token punctuation">;</span>
        lock.lockInterruptibly<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                //æŸ¥çœ‹é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ 
                E first <span class="token operator">=</span> q.peek<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                //è‹¥ä¸ºç©º,åˆ™å°†å½“å‰çº¿ç¨‹æ”¾å…¥ConditionObjectçš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶å°†åº•å±‚AQSçš„stateè®¾ç½®ä¸º0ï¼Œè¡¨ç¤ºé‡Šæ”¾é”å¹¶è¿›å…¥æ— é™æœŸç­‰å¾…
                <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> null<span class="token punctuation">)</span>
                    available.await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> <span class="token punctuation">{</span>
                	//è‹¥å…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™æŸ¥çœ‹å½“å‰å…ƒç´ å¤šä¹…åˆ°æœŸ
                    long delay <span class="token operator">=</span> first.getDelay<span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    //å¦‚æœå°äº0åˆ™è¯´æ˜å·²åˆ°æœŸç›´æ¥è¿”å›å‡ºå»
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>delay <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                        <span class="token builtin class-name">return</span> q.poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                     //å¦‚æœå¤§äº0åˆ™è¯´æ˜ä»»åŠ¡è¿˜æ²¡åˆ°æœŸï¼Œé¦–å…ˆéœ€è¦é‡Šæ”¾å¯¹è¿™ä¸ªå…ƒç´ çš„å¼•ç”¨
                    first <span class="token operator">=</span> null<span class="token punctuation">;</span> // don&#39;t retain ref <span class="token keyword">while</span> waiting
                    //åˆ¤æ–­leaderæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è¯´æ˜æ­£æœ‰çº¿ç¨‹ä½œä¸ºleaderå¹¶ç­‰å¾…ä¸€ä¸ªä»»åŠ¡åˆ°æœŸï¼Œåˆ™å½“å‰çº¿ç¨‹è¿›å…¥æ— é™æœŸç­‰å¾…
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                        available.await<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    	//åä¹‹å°†æˆ‘ä»¬çš„çº¿ç¨‹æˆä¸ºleader
                        Thread thisThread <span class="token operator">=</span> Thread.currentThread<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        leader <span class="token operator">=</span> thisThread<span class="token punctuation">;</span>
                        try <span class="token punctuation">{</span>
                        	//å¹¶è¿›å…¥æœ‰é™æœŸç­‰å¾…
                            available.awaitNanos<span class="token punctuation">(</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
                        //ç­‰å¾…ä»»åŠ¡åˆ°æœŸæ—¶ï¼Œé‡Šæ”¾leaderå¼•ç”¨ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯å°†ä»»åŠ¡returnå‡ºå»
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> thisThread<span class="token punctuation">)</span>
                                leader <span class="token operator">=</span> null<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
        //æ”¶å°¾é€»è¾‘:å¦‚æœleaderä¸ä¸ºç©ºä¸”qæœ‰å…ƒç´ ï¼Œåˆ™è¯´æ˜æœ‰ä»»åŠ¡æ²¡äººè®¤é¢†ï¼Œç›´æ¥å‘èµ·é€šçŸ¥å”¤é†’å› ä¸ºé”è¢«å½“å‰æ¶ˆè´¹è€…æŒæœ‰è€Œå¯¼è‡´é˜»å¡çš„ç”Ÿäº§è€…<span class="token punctuation">(</span>å³è°ƒç”¨putã€addã€offerçš„çº¿ç¨‹<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>leader <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> q.peek<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>
                available.signal<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //é‡Šæ”¾é”
            lock.unlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æˆ‘ä»¬å†æ¥çœ‹çœ‹éé˜»å¡çš„è·å–å…ƒç´ æ–¹æ³• poll ï¼Œé€»è¾‘æ¯”è¾ƒç®€å•ï¼Œæ•´ä½“æ­¥éª¤å¦‚ä¸‹:</p><ol><li>å°è¯•è·å–å¯é‡å…¥é”ã€‚</li><li>æŸ¥çœ‹é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ ,åˆ¤æ–­å…ƒç´ æ˜¯å¦ä¸ºç©ºã€‚</li><li>è‹¥å…ƒç´ ä¸ºç©ºï¼Œæˆ–è€…å…ƒç´ æœªåˆ°æœŸï¼Œåˆ™ç›´æ¥è¿”å›ç©ºã€‚</li><li>è‹¥å…ƒç´ ä¸ä¸ºç©ºä¸”åˆ°æœŸäº†ï¼Œç›´æ¥è°ƒç”¨pollè¿”å›å‡ºå»ã€‚</li><li>é‡Šæ”¾å¯é‡å…¥é” lock ã€‚</li></ol><p>æºç å¦‚ä¸‹,è¯»è€…å¯è‡ªè¡Œå‚é˜…æºç åŠæ³¨é‡Š:</p><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public E <span class="token function-name function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		//å°è¯•è·å–å¯é‡å…¥é”
        final ReentrantLock lock <span class="token operator">=</span> this.lock<span class="token punctuation">;</span>
        lock.lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
        //æŸ¥çœ‹é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå…ƒç´ ,åˆ¤æ–­å…ƒç´ æ˜¯å¦ä¸ºç©º
            E first <span class="token operator">=</span> q.peek<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			//è‹¥å…ƒç´ ä¸ºç©ºï¼Œæˆ–è€…å…ƒç´ æœªåˆ°æœŸï¼Œåˆ™ç›´æ¥è¿”å›ç©º
            <span class="token keyword">if</span> <span class="token punctuation">(</span>first <span class="token operator">==</span> null <span class="token operator">||</span> first.getDelay<span class="token punctuation">(</span>NANOSECONDS<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token builtin class-name">return</span> null<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
            //è‹¥å…ƒç´ ä¸ä¸ºç©ºä¸”åˆ°æœŸäº†ï¼Œç›´æ¥è°ƒç”¨pollè¿”å›å‡ºå»
                <span class="token builtin class-name">return</span> q.poll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
           //é‡Šæ”¾å¯é‡å…¥é”lock
            lock.unlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æŸ¥çœ‹å…ƒç´ " tabindex="-1"><a class="header-anchor" href="#æŸ¥çœ‹å…ƒç´ "><span>æŸ¥çœ‹å…ƒç´ </span></a></h3><p>ä¸Šæ–‡è·å–å…ƒç´ æ—¶éƒ½ä¼šè°ƒç”¨åˆ°peekæ–¹æ³•ï¼Œpeeké¡¾åæ€ä¹‰ä»…ä»…çª¥æ¢ä¸€ä¸‹é˜Ÿåˆ—ä¸­çš„å…ƒç´ ï¼Œå®ƒçš„æ­¥éª¤å°±4æ­¥:</p><ol><li>ä¸Šé”ã€‚</li><li>è°ƒç”¨ä¼˜å…ˆé˜Ÿåˆ—qçš„peekæ–¹æ³•æŸ¥çœ‹ç´¢å¼•0ä½ç½®çš„å…ƒç´ ã€‚</li><li>é‡Šæ”¾é”ã€‚</li><li>å°†å…ƒç´ è¿”å›å‡ºå»ã€‚</li></ol><div class="language-bash line-numbers-mode" data-ext="sh" data-title="sh"><pre class="language-bash"><code>public E <span class="token function-name function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        final ReentrantLock lock <span class="token operator">=</span> this.lock<span class="token punctuation">;</span>
        lock.lock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">{</span>
            <span class="token builtin class-name">return</span> q.peek<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{</span>
            lock.unlock<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="delayqueueå¸¸è§é¢è¯•é¢˜" tabindex="-1"><a class="header-anchor" href="#delayqueueå¸¸è§é¢è¯•é¢˜"><span>DelayQueueå¸¸è§é¢è¯•é¢˜</span></a></h2><h3 id="delayqueue-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#delayqueue-çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆ"><span>DelayQueue çš„å®ç°åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>DelayQueueåº•å±‚æ˜¯ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—PriorityQueueæ¥å­˜å‚¨å…ƒç´ ï¼Œè€ŒPriorityQueueé‡‡ç”¨äºŒå‰å°é¡¶å †çš„æ€æƒ³ç¡®ä¿å€¼å°çš„å…ƒç´ æ’åœ¨æœ€å‰é¢ï¼Œè¿™å°±ä½¿å¾—DelayQueueå¯¹äºå»¶è¿Ÿä»»åŠ¡ä¼˜å…ˆçº§çš„ç®¡ç†å°±å˜å¾—ååˆ†æ–¹ä¾¿äº†ã€‚åŒæ—¶DelayQueueä¸ºäº†ä¿è¯çº¿ç¨‹å®‰å…¨è¿˜ç”¨åˆ°äº†å¯é‡å…¥é”ReentrantLock,ç¡®ä¿å•ä½æ—¶é—´å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ“ä½œå»¶è¿Ÿé˜Ÿåˆ—ã€‚æœ€åï¼Œä¸ºäº†å®ç°å¤šçº¿ç¨‹ä¹‹é—´ç­‰å¾…å’Œå”¤é†’çš„äº¤äº’æ•ˆç‡ï¼ŒDelayQueueè¿˜ç”¨åˆ°äº†Conditionï¼Œé€šè¿‡Conditionçš„awaitå’Œsignalæ–¹æ³•å®Œæˆå¤šçº¿ç¨‹ä¹‹é—´çš„ç­‰å¾…å”¤é†’ã€‚</p><h3 id="delayqueue-çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›" tabindex="-1"><a class="header-anchor" href="#delayqueue-çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›"><span>DelayQueue çš„ä½¿ç”¨åœºæ™¯æœ‰å“ªäº›ï¼Ÿ</span></a></h3><p>DelayQueue é€šå¸¸ç”¨äºå®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦å’Œç¼“å­˜è¿‡æœŸåˆ é™¤ç­‰åœºæ™¯ã€‚åœ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦ä¸­ï¼Œéœ€è¦å°†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡å°è£…æˆå»¶è¿Ÿä»»åŠ¡å¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° DelayQueue ä¸­ï¼ŒDelayQueue ä¼šè‡ªåŠ¨æŒ‰ç…§å‰©ä½™å»¶è¿Ÿæ—¶é—´è¿›è¡Œå‡åºæ’åº(é»˜è®¤æƒ…å†µ)ï¼Œä»¥ä¿è¯ä»»åŠ¡èƒ½å¤ŸæŒ‰ç…§æ—¶é—´å…ˆåé¡ºåºæ‰§è¡Œã€‚å¯¹äºç¼“å­˜è¿‡æœŸè¿™ä¸ªåœºæ™¯è€Œè¨€ï¼Œåœ¨æ•°æ®è¢«ç¼“å­˜åˆ°å†…å­˜ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥å°†ç¼“å­˜çš„keyå°è£…æˆä¸€ä¸ªå»¶è¿Ÿçš„åˆ é™¤ä»»åŠ¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° DelayQueue ä¸­ï¼Œå½“æ•°æ®è¿‡æœŸæ—¶ï¼Œæ‹¿åˆ°è¿™ä¸ªä»»åŠ¡çš„keyï¼Œå°†è¿™ä¸ªkeyä»å†…å­˜ä¸­ç§»é™¤ã€‚</p><h3 id="delayqueue-ä¸­-delayed-æ¥å£çš„ä½œç”¨æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#delayqueue-ä¸­-delayed-æ¥å£çš„ä½œç”¨æ˜¯ä»€ä¹ˆ"><span>DelayQueue ä¸­ Delayed æ¥å£çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>Delayedæ¥å£å®šä¹‰äº†å…ƒç´ çš„å‰©ä½™å»¶è¿Ÿæ—¶é—´(getDelay)å’Œå…ƒç´ ä¹‹é—´çš„æ¯”è¾ƒè§„åˆ™(è¯¥æ¥å£ç»§æ‰¿äº†Comparableæ¥å£)ã€‚è‹¥å¸Œæœ›å…ƒç´ èƒ½å¤Ÿå­˜æ”¾åˆ°DelayQueue ä¸­ï¼Œå°±å¿…é¡»å®ç° Delayed æ¥å£çš„ getDelay() æ–¹æ³•å’Œ compareTo() æ–¹æ³•ï¼Œå¦åˆ™DelayQueueæ— æ³•å¾—çŸ¥å½“å‰ä»»åŠ¡å‰©ä½™æ—¶é•¿å’Œä»»åŠ¡ä¼˜å…ˆçº§çš„æ¯”è¾ƒã€‚</p><h3 id="delayqueue-å’Œ-timer-timertask-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#delayqueue-å’Œ-timer-timertask-çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ"><span>DelayQueue å’Œ Timer/TimerTask çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h3><p>DelayQueue å’Œ Timer/TimerTask éƒ½å¯ä»¥ç”¨äºå®ç°å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼Œä½†æ˜¯å®ƒä»¬çš„å®ç°æ–¹å¼ä¸åŒã€‚DelayQueue æ˜¯åŸºäºä¼˜å…ˆçº§é˜Ÿåˆ—å’Œå †æ’åºç®—æ³•å®ç°çš„ï¼Œå¯ä»¥å®ç°å¤šä¸ªä»»åŠ¡æŒ‰ç…§æ—¶é—´å…ˆåé¡ºåºæ‰§è¡Œï¼›è€Œ Timer/TimerTask æ˜¯åŸºäºå•çº¿ç¨‹å®ç°çš„ï¼Œåªèƒ½æŒ‰ç…§ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºä¾æ¬¡æ‰§è¡Œï¼Œå¦‚æœæŸä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œä¼šå½±å“å…¶ä»–ä»»åŠ¡çš„æ‰§è¡Œã€‚å¦å¤–ï¼ŒDelayQueue è¿˜æ”¯æŒåŠ¨æ€æ·»åŠ å’Œç§»é™¤ä»»åŠ¡ï¼Œè€Œ Timer/TimerTask åªèƒ½åœ¨åˆ›å»ºæ—¶æŒ‡å®šä»»åŠ¡ã€‚</p><h3 id="delayqueue-çš„å®ç°æ˜¯å¦çº¿ç¨‹å®‰å…¨" tabindex="-1"><a class="header-anchor" href="#delayqueue-çš„å®ç°æ˜¯å¦çº¿ç¨‹å®‰å…¨"><span>DelayQueue çš„å®ç°æ˜¯å¦çº¿ç¨‹å®‰å…¨ï¼Ÿ</span></a></h3><p>DelayQueue çš„å®ç°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå®ƒé€šè¿‡ ReentrantLock å®ç°äº†äº’æ–¥è®¿é—®å’Œ Condition å®ç°äº†çº¿ç¨‹é—´çš„ç­‰å¾…å’Œå”¤é†’æ“ä½œï¼Œå¯ä»¥ä¿è¯å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§å’Œå¯é æ€§ã€‚</p><h3 id="å®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„å‡ ç§æ–¹å¼" tabindex="-1"><a class="header-anchor" href="#å®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„å‡ ç§æ–¹å¼"><span>å®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„å‡ ç§æ–¹å¼</span></a></h3><p>å®ç°å»¶è¿Ÿé˜Ÿåˆ—çš„æ–¹å¼æœ‰å¾ˆå¤šï¼Œæˆ‘ä»¬éœ€è¦ç»“åˆåœºæ™¯é€‰ç”¨åˆé€‚çš„æ–¹æ¡ˆï¼Œæ€»ä½“æ¥è¯´æœ‰ä¸€ä¸‹å‡ ç§å®ç°æ–¹æ¡ˆ:</p><ol><li>DelayQueue:ç›´æ¥å°†ä»»åŠ¡åˆ°JDKè‡ªå¸¦çš„DelayQueueç”¨çº¿ç¨‹å»ç›‘å¬ã€‚</li><li>ç¬¬ä¸‰æ–¹ä»»åŠ¡è°ƒåº¦å·¥å…·:ä¾‹å¦‚Quartz ç­‰å®šæ—¶ä»»åŠ¡è°ƒåº¦å·¥å…·ã€‚</li><li>Redisæœ‰åºé›†åˆ:ä»¥æ—¶åˆ†ç§’ä½œä¸ºæ•´æ•°ç­‰æ–¹å¼ä½œä¸ºä¼˜å…ˆçº§ï¼Œå…ƒç´ ä½œä¸ºvalueå­˜åˆ°redis sorted setä¸­,ç„¶åJavaè¿›ç¨‹å»è½®è¯¢redisçš„seté›†åˆ,åˆ¤æ–­å½“å‰æ—¶é—´æ˜¯å¦åˆ°æœŸï¼Œè‹¥åˆ°æœŸåˆ™å°†å…ƒç´ ä»setä¸­ç§»é™¤å¹¶æ‰§è¡Œã€‚</li><li>Redisè¿‡æœŸå›è°ƒ:è®¾ç½® Redis è¿‡æœŸå›è°ƒç›‘å¬å³å°†åˆ°æœŸçš„keyã€‚</li><li>RabbitMQ: åŸºäº RabbitMQ çš„TTLå’ŒDLXè®¾ç½®å»¶è¿Ÿæ¶ˆæ¯ï¼Œå¾…å»¶è¿Ÿæ¶ˆæ¯è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—æ—¶å°†å…¶è½¬å‘åˆ°æ­£å¸¸æ¶ˆæ¯é˜Ÿåˆ—ä¸­ï¼Œæˆ‘ä»¬åªéœ€ç›‘å¬è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å¹¶å¤„ç†è¿™äº›ä»æ­»ä¿¡é˜Ÿåˆ—ä¸­è½¬å‘è¿‡æ¥çš„æ¶ˆæ¯å³å¯ã€‚</li><li>æ—¶é—´è½®ç®—æ³•: è¿™ç§ä¸æ˜¯å¾ˆå¸¸è§,ä»¥é’Ÿè¡¨ä¸ºä¸ºå•è¡¨ï¼Œè®¾ç½®å¥½æ—¶é—´ç‚¹indexå’Œåœˆæ•°round,å¾…æ—¶é—´è½®åˆ°è¾¾è¿™ä¸ªå€¼æ—¶å°†ä»»åŠ¡å–å‡ºæ‰§è¡Œã€‚</li></ol><p>è¯¦æƒ…å¯å‚è€ƒè¿™ç¯‡æ–‡ç« ,å†™çš„æ¯”è¾ƒè¯¦ç»†:<a href="https://blog.csdn.net/monokai/article/details/109023025" target="_blank" rel="noopener noreferrer">ä¸€å£æ°”è¯´å‡ºJava 6ç§å»¶æ—¶é˜Ÿåˆ—çš„å®ç°æ–¹æ³•(é¢è¯•å®˜ä¹Ÿå¾—æœ)<!----></a></p><h2 id="å‚è€ƒæ–‡çŒ®" tabindex="-1"><a class="header-anchor" href="#å‚è€ƒæ–‡çŒ®"><span>å‚è€ƒæ–‡çŒ®</span></a></h2><p>æ·±å…¥ç†è§£é«˜å¹¶å‘ç¼–ç¨‹ï¼šJDKæ ¸å¿ƒæŠ€æœ¯: <a href="https://book.douban.com/subject/36262609/" target="_blank" rel="noopener noreferrer">https://book.douban.com/subject/36262609/<!----></a></p><p>ä¸€å£æ°”è¯´å‡ºJava 6ç§å»¶æ—¶é˜Ÿåˆ—çš„å®ç°æ–¹æ³•(é¢è¯•å®˜ä¹Ÿå¾—æœ): <a href="https://www.jb51.net/article/186192.htm" target="_blank" rel="noopener noreferrer">https://www.jb51.net/article/186192.htm<!----></a></p><p>å›¾è§£DelayQueueæºç ï¼ˆjava 8ï¼‰â€”â€”å»¶æ—¶é˜Ÿåˆ—çš„å°ä¹ä¹: <a href="https://blog.csdn.net/every__day/article/details/113810985" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/every__day/article/details/113810985<!----></a></p></div><!--[--><!----><!--]--><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/HollowLatte/Note-Book/edit/main/docs/java/collection/delayqueue-source-code.md" rel="noopener noreferrer" target="_blank" aria-label="ç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->ç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: hollowlatte@outlook.com">hollowlatte</span><!--]--><!--]--></div></div></footer><!----><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer"><a href="https://beian.miit.gov.cn/" target="_blank">é„‚ICPå¤‡2020015769å·-1</a></div><div class="vp-copyright">Copyright Â© 2024 Hollow-Latte </div></footer></div><!--]--><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/Note-Book/assets/app-CjdU_M7_.js" defer></script>
  </body>
</html>
